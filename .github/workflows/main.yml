name: ðŸš€ Deploy to EC2 (Auth Service)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: ðŸ”„ Deploy via SSH
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸ“¦ Rsync project to EC2
        run: |
          rsync -avz --delete --exclude=node_modules --exclude='.git' ./ \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ secrets.DEPLOY_PATH }}-temp/

      - name: ðŸš€ Deploy and Restart Auth Service
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e

            echo "ðŸ” Swapping deployments..."
            rm -rf ${{ secrets.DEPLOY_PATH }}-old || true
            mv ${{ secrets.DEPLOY_PATH }} ${{ secrets.DEPLOY_PATH }}-old || true
            mv ${{ secrets.DEPLOY_PATH }}-temp ${{ secrets.DEPLOY_PATH }}

            cd ${{ secrets.DEPLOY_PATH }}

            echo "ðŸ“ Writing .env file..."
            cat > .env << 'EOT'
            SUPABASE_URL=${{ secrets.SUPABASE_URL }}
            SUPABASE_SERVICE_SECRET_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_SECRET_ROLE_KEY }}
            PORT=${{ secrets.PORT }}
            CORS_ORIGIN=${{ secrets.CORS_ORIGIN }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            EOT

            echo "ðŸ“¦ Installing dependencies..."
            npm install --omit=dev

            echo "ðŸ”¨ Building project..."
            npx --yes nest build || npx --yes @nestjs/cli build

            echo "ðŸš€ Restarting PM2..."
            pm2 restart ${{ secrets.PM2_PROCESS }} || pm2 start dist/main.js --name ${{ secrets.PM2_PROCESS }}
            pm2 save

            echo "ðŸ“‹ PM2 Logs:"
            pm2 logs ${{ secrets.PM2_PROCESS }} --lines 20 || echo "No logs yet"
          EOF